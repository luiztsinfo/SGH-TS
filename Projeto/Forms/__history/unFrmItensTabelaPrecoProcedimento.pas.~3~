unit unFrmItensTabelaPrecoProcedimento;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.ComCtrls, Vcl.ExtCtrls, Vcl.StdCtrls,
  Vcl.Buttons, Data.DB, Vcl.Grids, Vcl.DBGrids,
  Controller.Item_Tabela_Preco_MatMed, unConstantes;

type
  TfrmItensTabelaPrecoProcedimento = class(TForm)
    PnDadosTabela: TPanel;
    PnInclusaoItem: TPanel;
    PnConsultaItem: TPanel;
    PnItens: TPanel;
    lblTabelaPreco: TLabel;
    Label1: TLabel;
    lblMatMedFinal: TLabel;
    Label3: TLabel;
    lblMatMedInicial: TLabel;
    edtCodInicial: TEdit;
    edtCodFinal: TEdit;
    BtnBuscaMatMedInicial: TBitBtn;
    BtnBuscaMatMedFinal: TBitBtn;
    BtnIncluirItem: TBitBtn;
    GrdItensMatMed: TDBGrid;
    BtnExcluirItem: TBitBtn;
    BtnExcluirTudo: TBitBtn;
    StatusBar1: TStatusBar;
    RdGrpTipoBusca: TRadioGroup;
    edtConsulta: TEdit;
    Label2: TLabel;
    Label4: TLabel;
    Label5: TLabel;
    edtValor: TEdit;
    Label6: TLabel;
    procedure FormKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure BtnBuscaMatMedInicialClick(Sender: TObject);
    procedure edtCodInicialExit(Sender: TObject);
    procedure FormCreate(Sender: TObject);
    procedure FormDestroy(Sender: TObject);
    procedure edtCodFinalExit(Sender: TObject);
    procedure BtnBuscaMatMedFinalClick(Sender: TObject);
    procedure BtnIncluirItemClick(Sender: TObject);
    procedure edtConsultaKeyDown(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure FormShow(Sender: TObject);
    procedure BtnExcluirTudoClick(Sender: TObject);
    procedure BtnExcluirItemClick(Sender: TObject);
  private
    FController: TControllerItensTabelaPrecoMatMed;
    procedure LimparControles;
    procedure AlimentarModel;
    procedure AlimentarControles;
  public
    iID_TabelaPrecoProcedimento: integer;
  end;

var
  frmItensTabelaPrecoProcedimento: TfrmItensTabelaPrecoProcedimento;

implementation

{$R *.dfm}

uses unFrmMatMed, u_FrmBase;

procedure TfrmItensTabelaPrecoProcedimento.AlimentarControles;
begin
  edtCodInicial.Text := IntToStr(FController.Model.Id_MatMed);
  edtValor.Text := FloatToStr(FController.Model.Valor);
end;

procedure TfrmItensTabelaPrecoProcedimento.AlimentarModel;
begin
  FController.Model.Id_tabela_preco_matmed := iID_TabelaPrecoProcedimento;
  FController.Model.Id_MatMed := StrToInt(edtCodInicial.Text);
  FController.Model.Valor := StrToFloat(edtValor.Text);
end;

procedure TfrmItensTabelaPrecoProcedimento.BtnBuscaMatMedFinalClick(Sender: TObject);
var
  vValue: integer;
  frmMatMed: TFrmMatMeds;
begin
  inherited;
  try
    frmMatMed := TFrmMatMeds.Create(Self,toConsulta);
    frmMatMed.ShowModal;
  finally
    edtCodFinal.Text := IntToStr(frmMatMed.FValueFieldKey);

    if TryStrToInt(edtCodFinal.Text,vValue) then
      lblMatMedFinal.Caption := FController.GetDescricaoMatMed(vValue,iINCLUINDO);

    FreeAndNil(frmMatMed);
  end;
end;

procedure TfrmItensTabelaPrecoProcedimento.BtnBuscaMatMedInicialClick(
  Sender: TObject);
var
  vValue: integer;
  frmMatMed: TFrmMatMeds;
begin
  inherited;
  try
    frmMatMed := TFrmMatMeds.Create(Self,toConsulta);
    frmMatMed.ShowModal;
  finally
    edtCodInicial.Text := IntToStr(frmMatMed.FValueFieldKey);

    if TryStrToInt(edtCodInicial.Text,vValue) then
      lblMatMedInicial.Caption := FController.GetDescricaoMatMed(vValue,iINCLUINDO);

    FreeAndNil(frmMatMed);
  end;
end;

procedure TfrmItensTabelaPrecoProcedimento.BtnExcluirItemClick(Sender: TObject);
begin
  if FController.ExcluirItem then
    FController.MostrarTodosItens(iID_TabelaPrecoProcedimento);
end;

procedure TfrmItensTabelaPrecoProcedimento.BtnExcluirTudoClick(Sender: TObject);
begin
  if FController.ExcluirTodos then
    FController.MostrarTodosItens(iID_TabelaPrecoProcedimento);
end;

procedure TfrmItensTabelaPrecoProcedimento.BtnIncluirItemClick(Sender: TObject);
begin
  AlimentarModel;
  if FController.IncluirItem then
  begin
    FController.MostrarTodosItens(iID_TabelaPrecoProcedimento);
    LimparControles;
  end;

  edtCodInicial.SetFocus;
end;

procedure TfrmItensTabelaPrecoProcedimento.edtCodFinalExit(Sender: TObject);
var
  vValue: integer;
begin
  inherited;
  if TryStrToInt(edtCodFinal.Text,vValue) then
    lblMatMedFinal.Caption := FController.GetDescricaoMatMed(vValue,iINCLUINDO);
end;

procedure TfrmItensTabelaPrecoProcedimento.edtCodInicialExit(Sender: TObject);
var
  vValue: integer;
begin
  inherited;
  if TryStrToInt(edtCodInicial.Text,vValue) then
    lblMatMedInicial.Caption := FController.GetDescricaoMatMed(vValue,iINCLUINDO);
end;

procedure TfrmItensTabelaPrecoProcedimento.edtConsultaKeyDown(Sender: TObject;
  var Key: Word; Shift: TShiftState);
begin
  if Key = VK_RETURN then
    FController.ConsultarItemTabelaMatMed(RdGrpTipoBusca.ItemIndex,edtConsulta.Text);
end;

procedure TfrmItensTabelaPrecoProcedimento.FormCreate(Sender: TObject);
begin
  FController := TControllerItensTabelaPrecoMatMed.Create;
  GrdItensMatMed.DataSource := FController.DataSource;
end;

procedure TfrmItensTabelaPrecoProcedimento.FormDestroy(Sender: TObject);
begin
  FreeAndNil(FController);
end;

procedure TfrmItensTabelaPrecoProcedimento.FormKeyDown(Sender: TObject; var Key: Word;
  Shift: TShiftState);
begin
  if key = VK_ESCAPE then
    Self.Close;
end;

procedure TfrmItensTabelaPrecoProcedimento.FormShow(Sender: TObject);
begin
  FController.IDTabelaMatMed := iID_TabelaPrecoProcedimento;
  if iID_TabelaPrecoProcedimento > 0 then
    FController.MostrarTodosItens(iID_TabelaPrecoProcedimento);
end;

procedure TfrmItensTabelaPrecoProcedimento.LimparControles;
begin
  edtCodInicial.Clear;
  edtValor.Text := '0,00';
end;

end.
